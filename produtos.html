<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Berserk Armor</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="logo">
        <span class="logo-icon">⚔️</span>
        <div>
          <h1><a href="index.html">Berserk Armor</a></h1>
          <p class="tagline">Cupcakes Artesanais</p>
        </div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="produtos.html" class="active">Produtos</a>
        <a href="carrinho.html">Carrinho (<span id="contadorCarrinho">0</span>)</a>
        <span id="userMenu"></span>
      </nav>
    </div>
  </header>

  <main class="container" style="padding: 40px 24px; min-height: calc(100vh - 200px);">
    <section>
      <h2 class="section-title">Nossos Produtos</h2>
      
      <div style="display: flex; gap: 16px; margin-bottom: 40px; flex-wrap: wrap;">
        <input 
          type="text" 
          id="busca" 
          placeholder="Buscar produtos..."
          style="flex: 1; min-width: 250px; padding: 14px 20px; background: var(--preto-card); border: 2px solid rgba(0,102,255,0.3); border-radius: 12px; color: var(--texto-branco); font-size: 1rem;"
        >
        
        <select id="filtroCategoria" style="padding: 14px 20px; background: var(--preto-card); border: 2px solid rgba(0,102,255,0.3); border-radius: 12px; color: var(--texto-branco); font-size: 1rem; cursor: pointer;">
          <option value="todos">Todas Categorias</option>
          <option value="chocolate">Chocolate</option>
          <option value="frutas">Frutas</option>
          <option value="especial">Especiais</option>
          <option value="classico">Clássicos</option>
        </select>
      </div>
      
      <div class="produtos-grid" id="produtosGrid">
        <div class="loading">Carregando produtos...</div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 Berserk Armor - Desenvolvido por Sivaldo Silva</p>
    </div>
  </footer>

  <script>
    let produtos = [];
    let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
    
    function verificarUsuario() {
      const usuario = JSON.parse(localStorage.getItem('usuario'));
      const userMenu = document.getElementById('userMenu');
      
      if (usuario) {
        userMenu.innerHTML = `
          <span class="user-info">Olá, ${usuario.nome.split(' ')[0]}!</span>
          <a href="pedidos.html">Pedidos</a>
          <a href="#" onclick="logout()">Sair</a>
        `;
      } else {
        userMenu.innerHTML = `
          <a href="login.html">Login</a>
          <a href="cadastro.html" class="btn-nav btn-primary">Cadastrar</a>
        `;
      }
    }
    
    function logout() {
      localStorage.removeItem('usuario');
      window.location.href = 'index.html';
    }
    
    function atualizarContador() {
      const total = carrinho.reduce((sum, item) => sum + item.quantidade, 0);
      document.getElementById('contadorCarrinho').textContent = total;
    }
    
    async function carregarProdutos(categoria = 'todos', busca = '') {
      try {
        let url = 'http://localhost:3000/api/produtos';
        const params = new URLSearchParams();
        
        if (categoria !== 'todos') params.append('categoria', categoria);
        if (busca) params.append('busca', busca);
        
        if (params.toString()) url += '?' + params.toString();
        
        const response = await fetch(url);
        produtos = await response.json();
        
        exibirProdutos();
        
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        document.getElementById('produtosGrid').innerHTML = 
          '<p class="error-message">Erro ao carregar produtos. Verifique se o backend está rodando.</p>';
      }
    }
    
    function exibirProdutos() {
      const grid = document.getElementById('produtosGrid');
      
      if (produtos.length === 0) {
        grid.innerHTML = '<p class="no-produtos">Nenhum produto encontrado</p>';
        return;
      }
      
      grid.innerHTML = produtos.map(produto => `
        <div class="produto-card">
          <img src="${produto.imagem}" alt="${produto.nome}" class="produto-img">
          <div class="produto-info">
            <h3>${produto.nome}</h3>
            <p class="produto-desc">${produto.descricao}</p>
            <div class="produto-footer">
              <span class="preco">R$ ${produto.preco.toFixed(2)}</span>
              <span class="estoque">${produto.estoque} em estoque</span>
            </div>
            ${produto.estoque > 0 ? `
              <button 
                onclick="adicionarAoCarrinho(${produto.id})" 
                class="btn-produto"
                ${estaNoCarrinho(produto.id) ? 'disabled' : ''}
              >
                ${estaNoCarrinho(produto.id) ? 'No Carrinho' : 'Adicionar'}
              </button>
            ` : `
              <button class="btn-produto" disabled>Esgotado</button>
            `}
          </div>
        </div>
      `).join('');
    }
    
    function estaNoCarrinho(produtoId) {
      return carrinho.some(item => item.produtoId === produtoId);
    }
    
    function adicionarAoCarrinho(produtoId) {
      const produto = produtos.find(p => p.id === produtoId);
      
      if (!produto || produto.estoque === 0) return;
      
      if (estaNoCarrinho(produtoId)) {
        alert('Produto já está no carrinho!');
        return;
      }
      
      carrinho.push({
        produtoId: produto.id,
        nome: produto.nome,
        preco: produto.preco,
        imagem: produto.imagem,
        quantidade: 1,
        estoqueDisponivel: produto.estoque
      });
      
      localStorage.setItem('carrinho', JSON.stringify(carrinho));
      atualizarContador();
      exibirProdutos();
      
      mostrarToast('Produto adicionado ao carrinho!');
    }
    
    function mostrarToast(mensagem) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = mensagem;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    document.getElementById('filtroCategoria').addEventListener('change', (e) => {
      const categoria = e.target.value;
      const busca = document.getElementById('busca').value;
      carregarProdutos(categoria, busca);
    });
    
    document.getElementById('busca').addEventListener('input', (e) => {
      const busca = e.target.value;
      const categoria = document.getElementById('filtroCategoria').value;
      
      clearTimeout(window.buscaTimeout);
      window.buscaTimeout = setTimeout(() => {
        carregarProdutos(categoria, busca);
      }, 500);
    });
    
    verificarUsuario();
    atualizarContador();
    
    const urlParams = new URLSearchParams(window.location.search);
    const categoriaUrl = urlParams.get('categoria');
    
    if (categoriaUrl) {
      document.getElementById('filtroCategoria').value = categoriaUrl;
      carregarProdutos(categoriaUrl);
    } else {
      carregarProdutos();
    }
  </script>
</body>
</html>
